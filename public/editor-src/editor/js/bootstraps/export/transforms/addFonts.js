/**
 * Parses the page and the css generated by glamor
 * and finds all inline font families that were used in it and appends them to head
 */

import {
  makeSubsetGoogleFontsUrl,
  makeRichTextFontGoogleCSS,
  makeUploadFontsUrl,
  makeRichTextFontUploadCSS
} from "visual/utils/fonts";

export default function addFonts($, { google, upload }) {
  generateGoogleAssets($, google);

  if (upload.length) {
    generateUploadAssets($, upload);
  }
}
function generateGoogleAssets($, _fonts) {
  const fonts = _fonts.filter(font => font.deleted !== true);

  if (fonts.length) {
    const fontsUrl = makeSubsetGoogleFontsUrl(fonts);
    const richTextFamiliesCSS = makeRichTextFontGoogleCSS(fonts);

    $("head")
      .append(
        `<link class="brz-link brz-link-google" type="text/css" rel="stylesheet" href="${fontsUrl}" />`
      )
      .append(`<style class="brz-style">${richTextFamiliesCSS}</style>`);
  }
}

function generateUploadAssets($, _fonts) {
  const fonts = _fonts.filter(font => font.deleted !== true);

  if (fonts.length) {
    const fontsUrl = makeUploadFontsUrl(fonts);
    const richTextFamiliesCSS = makeRichTextFontUploadCSS(fonts);

    $("head")
      .append(
        `<link class="brz-link brz-link-upload" type="text/css" rel="stylesheet" href="${fontsUrl}" />`
      )
      .append(`<style class="brz-style">${richTextFamiliesCSS}</style>`);
  }
}
