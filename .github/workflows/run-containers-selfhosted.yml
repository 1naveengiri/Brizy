name: Brizy Free

on:
  push:
    branches:
      - master
jobs:
  base:
    environment: Build
    runs-on: self-hosted
    steps:
      - name: Checkout main
        uses: actions/checkout@v2
        with:
          path: main

      - name: Load Build Evnrorment Data
        uses: falti/dotenv-action@master
        id: env
        with:
          path: main/.github/.build-env

      - name: Declare some variables
        id: vars
        shell: bash
        run: |
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: Checkout BB
        uses: actions/checkout@v2
        with:
          repository: git@github.com:bagrinsergiu/BB.git
          ref: master
          ssh-key: ${{ secrets.ACCESS_KEY }}
          path: bb
          submodules: 'recursive'
          fetch-depth: '1'

      - name: Change submodule branches
        id: change-branches-on-bb
        shell: bash
        run: |
          cd bb/editor && git checkout origin/${EDITOR_BRANCH}
          cd bb/worpdress/www/wp-content/plugins/brizy && git checkout origin/${FREE_BRANCH}
          cd bb/worpdress/www/wp-content/plugins/brizy-pro && git checkout origin/${PRO_BRANCH}

#      - name: Build mysql image
#        id: change-branches-on-bb
#        shell: bash
#        run: |
#          mysqlContainerName="testing-mysql-${BUILD_ENVIRONMENT}"
#          brizyMysqlImage="brizy/testing-mysql:${BUILD_ENVIRONMENT}"
#          dbName="brizy-${target}"
#          docker stop "${mysqlContainerName}" || true
#          docker build -t "${brizyMysqlImage}" --target build-deployment bb/mysql
#          docker run -d --rm --network="traefik" \
#                          --network-alias="${mysqlContainerName}" \
#                          --name="${mysqlContainerName}" \
#                          --cpus=3 \
#                          --memory=2g \
#                          -e "MAX_CPUS=3" \
#                          -e "MYSQL_ROOT_PASSWORD=nopassword" \
#                          -e "MYSQL_DATABASE=${dbName}" \
#                          -e "MYSQL_USER=brizy" \
#                          -e "MYSQL_PASSWORD=nopassword" \
#                         "${brizyMysqlImage}"






#      - name: Intialize  the  containers
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          key: ${{ secrets.KEY }}
#          port: ${{ secrets.PORT }}
#          command_timeout: 200m
#          passphrase: ${{ secrets.KEY_PASSPHRASE }}
#          script: |
#            ./BB/build/run-editor-instance.sh \
#            -c ${{ steps.vars.outputs.sha_short }} \
#            -v ${{ steps.env.outputs.build_environment }} \
#            -f ${{ steps.env.outputs.free_branch }} \
#            -p ${{ steps.env.outputs.pro_branch }} \
#            -e ${{ steps.env.outputs.editor_branch }} \
#            -n traefik \
#            -t ${{ secrets.COMPOSER_TOKEN }}
#      - name: Clean context folder
#        uses: appleboy/ssh-action@master
#        if: ${{ always() }}
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          key: ${{ secrets.KEY }}
#          port: ${{ secrets.PORT }}
#          command_timeout: 200m
#          passphrase: ${{ secrets.KEY_PASSPHRASE }}
#          script:
#            ./BB/build/clean-context-folder.sh -c ${{ steps.vars.outputs.sha_short }}
